<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>GRAPES: chunkiser_test.c</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">GRAPES
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">chunkiser_test.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>A test program showing how to use the chunkiser and dechunkiser API.</p>
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> *  Copyright (c) 2010 Csaba Kiraly</span>
<span class="comment"> *  Copyright (c) 2010 Luca Abeni</span>
<span class="comment"> *</span>
<span class="comment"> *  This is free software; see gpl-3.0.txt</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;unistd.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;stdint.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<span class="preprocessor">#include &lt;sys/time.h&gt;</span>

<span class="preprocessor">#include &quot;<a class="code" href="chunk_8h.html" title="Chunk structure.">chunk.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="chunkiser_8h.html" title="Split an audio/video stream in chunks.">chunkiser.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="net__helper_8h.html" title="Communication facility interface for SOM.">net_helper.h</a>&quot;</span>

<span class="keyword">static</span> <span class="keywordtype">char</span> out_opts[1024];
<span class="keyword">static</span> <span class="keywordtype">char</span> *out_ptr = out_opts;
<span class="keyword">static</span> <span class="keywordtype">char</span> in_opts[1024];
<span class="keyword">static</span> <span class="keywordtype">char</span> *in_ptr = in_opts;
<span class="keyword">static</span> <span class="keywordtype">int</span> udp_port;
<span class="keyword">static</span> <span class="keywordtype">int</span> out_udp_port;
<span class="keyword">static</span> <span class="keywordtype">int</span> timed;

<span class="keyword">static</span> <span class="keyword">struct </span>timeval tnext;

<span class="keyword">static</span> <span class="keywordtype">int</span> verbose;

<span class="keyword">static</span> <span class="keywordtype">void</span> help(<span class="keyword">const</span> <span class="keywordtype">char</span> *name)
{
  fprintf(stderr, <span class="stringliteral">&quot;Usage: %s [options] &lt;input&gt; &lt;output&gt;\n&quot;</span>, name);
  fprintf(stderr, <span class="stringliteral">&quot;options: u:f:rRdlavVUT\n&quot;</span>);
  fprintf(stderr, <span class="stringliteral">&quot;\t -u &lt;port&gt;: use the UDP chunkiser (on &lt;port&gt;) for input\n&quot;</span>);
  fprintf(stderr, <span class="stringliteral">&quot;\t -P &lt;port&gt;: use the UDP chunkiser (on &lt;port&gt;) for output\n&quot;</span>);
  fprintf(stderr, <span class="stringliteral">&quot;\t -f &lt;fmt&gt;: use the &lt;fmt&gt; format for ouptut (libav-based)\n&quot;</span>);
  fprintf(stderr, <span class="stringliteral">&quot;\t -r: use RAW output\n&quot;</span>);
  fprintf(stderr, <span class="stringliteral">&quot;\t -R: use RAW output, removing the libav payload header\n&quot;</span>);
  fprintf(stderr, <span class="stringliteral">&quot;\t -d: use the dummy chunkiser\n&quot;</span>);
  fprintf(stderr, <span class="stringliteral">&quot;\t -l: loop\n&quot;</span>);
  fprintf(stderr, <span class="stringliteral">&quot;\t -a: audio-only in the libav ouptut\n&quot;</span>);
  fprintf(stderr, <span class="stringliteral">&quot;\t -v: video-only in the libav output\n&quot;</span>);
  fprintf(stderr, <span class="stringliteral">&quot;\t -V: audio/video in the libav output\n&quot;</span>);
  fprintf(stderr, <span class="stringliteral">&quot;\t -U: use RAW output, removing the UDP payload header\n&quot;</span>);
  fprintf(stderr, <span class="stringliteral">&quot;\t -T: use RAW output, removing the RTP payload heade\n&quot;</span>);
  fprintf(stderr, <span class="stringliteral">&quot;\t -I &lt;config&gt;: specify the chunkiser config\n&quot;</span>);
  fprintf(stderr, <span class="stringliteral">&quot;\t -O &lt;config&gt;: specify the dechunkiser config\n&quot;</span>);
}

<span class="keyword">static</span> <span class="keywordtype">char</span> *addopt(<span class="keywordtype">char</span> *opts, <span class="keywordtype">char</span> *opts_ptr, <span class="keyword">const</span> <span class="keywordtype">char</span> *tag, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
{
  <span class="keywordflow">if</span> (opts_ptr != opts) {
    *opts_ptr++ = <span class="charliteral">&#39;,&#39;</span>;
  }
  opts_ptr += sprintf(opts_ptr, <span class="stringliteral">&quot;%s=%s&quot;</span>, tag, value);
  <span class="keywordflow">return</span> opts_ptr;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> cmdline_parse(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
  <span class="keywordtype">int</span> o;

  <span class="keywordflow">while</span> ((o = getopt(argc, argv, <span class="stringliteral">&quot;slP:u:f:rRdlavVxUTO:I:&quot;</span>)) != -1) {
    <span class="keywordtype">char</span> port[8];

    <span class="keywordflow">switch</span>(o) {
      <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:
        timed = 1;
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;l&#39;</span>:
        in_ptr = addopt(in_opts, in_ptr, <span class="stringliteral">&quot;loop&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;P&#39;</span>:
        <span class="keywordflow">if</span> (out_udp_port == 0) {
          out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;dechunkiser&quot;</span>, <span class="stringliteral">&quot;udp&quot;</span>);
        }
        sprintf(port, <span class="stringliteral">&quot;port%d&quot;</span>, out_udp_port);
        out_udp_port++;
        out_ptr = addopt(out_opts, out_ptr, port, optarg);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;u&#39;</span>:
        <span class="keywordflow">if</span> (udp_port == 0) {
          in_ptr = addopt(in_opts, in_ptr, <span class="stringliteral">&quot;chunkiser&quot;</span>, <span class="stringliteral">&quot;udp&quot;</span>);
        }
        sprintf(port, <span class="stringliteral">&quot;port%d&quot;</span>, udp_port);
        udp_port++;
        in_ptr = addopt(in_opts, in_ptr, port, optarg);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;f&#39;</span>:
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;format&quot;</span>, optarg);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;r&#39;</span>:
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;dechunkiser&quot;</span>, <span class="stringliteral">&quot;raw&quot;</span>);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;R&#39;</span>:
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;dechunkiser&quot;</span>, <span class="stringliteral">&quot;raw&quot;</span>);
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;payload&quot;</span>, <span class="stringliteral">&quot;avf&quot;</span>);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;U&#39;</span>:
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;dechunkiser&quot;</span>, <span class="stringliteral">&quot;raw&quot;</span>);
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;payload&quot;</span>, <span class="stringliteral">&quot;udp&quot;</span>);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;T&#39;</span>:
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;dechunkiser&quot;</span>, <span class="stringliteral">&quot;raw&quot;</span>);
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;payload&quot;</span>, <span class="stringliteral">&quot;rtp&quot;</span>);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:
        in_ptr = addopt(in_opts, in_ptr, <span class="stringliteral">&quot;chunkiser&quot;</span>, <span class="stringliteral">&quot;dummy&quot;</span>);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;a&#39;</span>:
        in_ptr = addopt(in_opts, in_ptr, <span class="stringliteral">&quot;chunkiser&quot;</span>, <span class="stringliteral">&quot;avf&quot;</span>);
        in_ptr = addopt(in_opts, in_ptr, <span class="stringliteral">&quot;media&quot;</span>, <span class="stringliteral">&quot;audio&quot;</span>);
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;dechunkiser&quot;</span>, <span class="stringliteral">&quot;avf&quot;</span>);
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;media&quot;</span>, <span class="stringliteral">&quot;audio&quot;</span>);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span>:
        in_ptr = addopt(in_opts, in_ptr, <span class="stringliteral">&quot;chunkiser&quot;</span>, <span class="stringliteral">&quot;avf&quot;</span>);
        in_ptr = addopt(in_opts, in_ptr, <span class="stringliteral">&quot;media&quot;</span>, <span class="stringliteral">&quot;video&quot;</span>);
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;dechunkiser&quot;</span>, <span class="stringliteral">&quot;avf&quot;</span>);
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;media&quot;</span>, <span class="stringliteral">&quot;video&quot;</span>);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;V&#39;</span>:
        in_ptr = addopt(in_opts, in_ptr, <span class="stringliteral">&quot;chunkiser&quot;</span>, <span class="stringliteral">&quot;avf&quot;</span>);
        in_ptr = addopt(in_opts, in_ptr, <span class="stringliteral">&quot;media&quot;</span>, <span class="stringliteral">&quot;av&quot;</span>);
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;dechunkiser&quot;</span>, <span class="stringliteral">&quot;avf&quot;</span>);
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;media&quot;</span>, <span class="stringliteral">&quot;av&quot;</span>);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;x&#39;</span>:
        in_ptr = addopt(in_opts, in_ptr, <span class="stringliteral">&quot;chunkiser&quot;</span>, <span class="stringliteral">&quot;avf&quot;</span>);
        in_ptr = addopt(in_opts, in_ptr, <span class="stringliteral">&quot;media&quot;</span>, <span class="stringliteral">&quot;av&quot;</span>);
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;dechunkiser&quot;</span>, <span class="stringliteral">&quot;play&quot;</span>);
        out_ptr = addopt(out_opts, out_ptr, <span class="stringliteral">&quot;media&quot;</span>, <span class="stringliteral">&quot;av&quot;</span>);
        timed = 1;
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;O&#39;</span>:
        out_ptr += sprintf(out_ptr, <span class="stringliteral">&quot;%s&quot;</span>, optarg);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;I&#39;</span>:
        in_ptr += sprintf(in_ptr, <span class="stringliteral">&quot;%s&quot;</span>, optarg);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">default</span>:
        fprintf(stderr, <span class="stringliteral">&quot;Error: unknown option %c\n&quot;</span>, o);

        exit(-1);
    }
  }

  <span class="keywordflow">return</span> optind - 1;
}

<span class="keywordtype">void</span> tout_init(<span class="keyword">struct</span> timeval *tv)
{
  <span class="keyword">struct </span>timeval tnow;

  gettimeofday(&amp;tnow, NULL);
  <span class="keywordflow">if</span>(timercmp(&amp;tnow, &amp;tnext, &lt;)) {
    timersub(&amp;tnext, &amp;tnow, tv);
  } <span class="keywordflow">else</span> {
    *tv = (<span class="keyword">struct </span>timeval){0, 0};
  }
}

<span class="keyword">static</span> <span class="keywordtype">void</span> in_wait(<span class="keyword">const</span> <span class="keywordtype">int</span> *fd, uint64_t ts)
{
  <span class="keywordtype">int</span> my_fd[10], *pfd;
  <span class="keywordtype">int</span> i = 0;
  <span class="keyword">struct </span>timeval tv, *ptv, tadd;
  <span class="keyword">static</span> <span class="keyword">struct </span>timeval tfirst;
  <span class="keyword">static</span> uint64_t tsfirst;
  
  <span class="keywordflow">if</span> (ts == (uint64_t)-1) {
    ptv = NULL;
  } <span class="keywordflow">else</span> {
    <span class="keywordflow">if</span> (tfirst.tv_sec == 0) {
      gettimeofday(&amp;tfirst, NULL);
      tsfirst = ts;
    }
    <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;Sleep %llu\n&quot;</span>, ts - tsfirst);
    tadd.tv_sec = (ts - tsfirst) / 1000000;
    tadd.tv_usec = (ts - tsfirst) % 1000000;
    timeradd(&amp;tfirst, &amp;tadd, &amp;tnext);
    tout_init(&amp;tv);
    ptv = &amp;tv;
  }
  <span class="keywordflow">if</span> (fd) {
    <span class="keywordflow">while</span>(fd[i] != -1) {
      my_fd[i] = fd[i];
      i++;
    }
    pfd = my_fd;
  } <span class="keywordflow">else</span> {
    pfd = NULL;
    <span class="keywordflow">if</span> (ptv == NULL) {
      <span class="keywordflow">return</span>;
    }
  }
  my_fd[i] = -1;

  <a name="a0"></a><a class="code" href="net__helper_8h.html#aba639b19170daf84c4b84e8f59eba6a3" title="Check for newly arrived data.">wait4data</a>(NULL, ptv, pfd);
}

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
  <span class="keywordtype">int</span> period, done, id;
  <span class="keyword">struct </span>input_stream *input;
  <span class="keyword">struct </span>output_stream *output;
  <span class="keyword">const</span> <span class="keywordtype">int</span> *in_fds;
  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> ts;

  <span class="keywordflow">if</span> (argc &lt; 3) {
    help(argv[0]);

    <span class="keywordflow">return</span> -1;
  }
  argv += cmdline_parse(argc, argv);
  input = <a name="a1"></a><a class="code" href="chunkiser_8h.html#ad636f4659e4007be625bcf34ca7f8bc8" title="Initialise a chunkiser.">input_stream_open</a>(argv[1], &amp;period, in_opts);
  <span class="keywordflow">if</span> (input == NULL) {
    fprintf(stderr, <span class="stringliteral">&quot;Cannot open input %s\n&quot;</span>, argv[1]);

    <span class="keywordflow">return</span> -1;
  }
  <span class="keywordflow">if</span> (period == 0) {
    in_fds = <a name="a2"></a><a class="code" href="chunkiser_8h.html#a026350d08ef244af409bd81d4ee6ecfe" title="Return the FDs used for input.">input_get_fds</a>(input);
  } <span class="keywordflow">else</span> {
    in_fds = NULL;
  }
  output = <a name="a3"></a><a class="code" href="chunkiser_8h.html#a8a5bf519cf61402134200110916686d0" title="Initialise a dechunkiser.">out_stream_init</a>(argv[2], out_opts);
  <span class="keywordflow">if</span> (output == NULL) {
    fprintf(stderr, <span class="stringliteral">&quot;Cannot open output %s\n&quot;</span>, argv[2]);

    <span class="keywordflow">return</span> -1;
  }

  done = 0; <span class="keywordtype">id</span> = 0;
  <span class="keywordflow">while</span>(!done) {
    <span class="keywordtype">int</span> res;
    <span class="keyword">struct </span><a name="_a4"></a><a class="code" href="structchunk.html">chunk</a> c;

    c.<a name="a5"></a><a class="code" href="structchunk.html#a4015509e73a5a280c7a22eafe9219306">id</a> = <a class="code" href="structchunk.html#a4015509e73a5a280c7a22eafe9219306">id</a>;
    res = <a name="a6"></a><a class="code" href="chunkiser_8h.html#aea8f43a6a9f383068e1565f2d85b2fce" title="Read a chunk.">chunkise</a>(input, &amp;c);
    <span class="keywordflow">if</span> (res &gt; 0) {
      <span class="keywordflow">if</span> (verbose) fprintf(stderr,<span class="stringliteral">&quot;chunk %d: %d %llu\n&quot;</span>, <span class="keywordtype">id</span>++, c.size, c.timestamp);
      ts = timed ? c.timestamp : (uint64_t)-1;
      in_wait(in_fds, ts);
      <a name="a7"></a><a class="code" href="chunkiser_8h.html#ad8c7de635eebaec8b61966753370e056" title="Write a chunk.">chunk_write</a>(output, &amp;c);
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &lt; 0) {
      done = 1;
    }
    free(c.data);
  }
  <a name="a8"></a><a class="code" href="chunkiser_8h.html#a0532f8be6659d93cee2ce719e4b1d500" title="Cleanup a chunkiser.">input_stream_close</a>(input);
  <a name="a9"></a><a class="code" href="chunkiser_8h.html#aab11595945e636e65d10d29ac4618a14" title="Cleanup a dechunkiser.">out_stream_close</a>(output);

  <span class="keywordflow">return</span> 0;
}
</pre></div> </div><!-- contents -->
</div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Fri May 3 2013 10:18:23 for GRAPES by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
