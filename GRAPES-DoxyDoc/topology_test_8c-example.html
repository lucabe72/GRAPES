<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>GRAPES: topology_test.c</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">GRAPES
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">topology_test.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>A simple example showing how to use the Peer Sampler API.</p>
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> *  Copyright (c) 2009 Luca Abeni</span>
<span class="comment"> *</span>
<span class="comment"> *  This is free software; see gpl-3.0.txt</span>
<span class="comment"> *</span>
<span class="comment"> *  This is a small test program for the gossip based TopologyManager</span>
<span class="comment"> *  To try the simple test: run it with</span>
<span class="comment"> *    ./topology_test -I &lt;network interface&gt; -P &lt;port&gt; [-i &lt;remote IP&gt; -p &lt;remote port&gt;]</span>
<span class="comment"> *    the &quot;-i&quot; and &quot;-p&quot; parameters can be used to add an initial neighbour</span>
<span class="comment"> *    (otherwise, the peer risks to stay out of the overlay).</span>
<span class="comment"> *    For example, run</span>
<span class="comment"> *      ./topology_test -I eth0 -P 6666</span>
<span class="comment"> *    on a computer, and then</span>
<span class="comment"> *      ./topology_test -I eth0 -P 2222 -i &lt;ip_address&gt; -p 6666</span>
<span class="comment"> *  on another one ... Of course, one of the two peers has to use -i... -p...</span>
<span class="comment"> *  (in general, to be part of the overlay a peer must either use</span>
<span class="comment"> *  &quot;-i&lt;known peer IP&gt; -p&lt;known peer port&gt;&quot; or be referenced by another peer).</span>
<span class="comment"> */</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;stdint.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;getopt.h&gt;</span>

<span class="preprocessor">#include &quot;<a class="code" href="net__helper_8h.html" title="Communication facility interface for SOM.">net_helper.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="peersampler_8h.html" title="Peer Sampler interface.">peersampler.h</a>&quot;</span>
<span class="preprocessor">#include &quot;net_helpers.h&quot;</span>

<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *psample_config;
<span class="keyword">static</span> <span class="keyword">struct </span>psample_context *context;
<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *my_addr = <span class="stringliteral">&quot;127.0.0.1&quot;</span>;
<span class="keyword">static</span> <span class="keywordtype">int</span> port = 6666;
<span class="keyword">static</span> <span class="keywordtype">int</span> srv_port;
<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *srv_ip;
<span class="keyword">static</span> <span class="keywordtype">char</span> *fprefix;

<span class="keyword">static</span> <span class="keywordtype">void</span> cmdline_parse(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
  <span class="keywordtype">int</span> o;

  <span class="keywordflow">while</span> ((o = getopt(argc, argv, <span class="stringliteral">&quot;s:p:i:P:I:cno&quot;</span>)) != -1) {
    <span class="keywordflow">switch</span>(o) {
      <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:
        srv_port = atoi(optarg);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span>:
        srv_ip = strdup(optarg);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;P&#39;</span>:
        port =  atoi(optarg);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;I&#39;</span>:
        my_addr = iface_addr(optarg);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:
        fprefix = strdup(optarg);
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:
        psample_config = <span class="stringliteral">&quot;protocol=cyclon&quot;</span>;
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;n&#39;</span>:
        psample_config = <span class="stringliteral">&quot;protocol=newscast&quot;</span>;
        <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> <span class="charliteral">&#39;o&#39;</span>:
        psample_config = <span class="stringliteral">&quot;protocol=newscastplus&quot;</span>;
        <span class="keywordflow">break</span>;
      <span class="keywordflow">default</span>:
        fprintf(stderr, <span class="stringliteral">&quot;Error: unknown option %c\n&quot;</span>, o);

        exit(-1);
    }
  }
}

<span class="keyword">static</span> <span class="keyword">struct </span>nodeID *init(<span class="keywordtype">void</span>)
{
  <span class="keyword">struct </span>nodeID *myID;

  myID = <a name="a0"></a><a class="code" href="net__helper_8h.html#a75c24f68a227ceca874aee06e35aef6f" title="Initialize all needed internal parameters.">net_helper_init</a>(my_addr, port, <span class="stringliteral">&quot;&quot;</span>);
  <span class="keywordflow">if</span> (myID == NULL) {
    fprintf(stderr, <span class="stringliteral">&quot;Error creating my socket (%s:%d)!\n&quot;</span>, my_addr, port);

    <span class="keywordflow">return</span> NULL;
  }
  context = <a name="a1"></a><a class="code" href="peersampler_8h.html#ae727e8be9d2f4492094fc993f16d3cf8" title="Initialise the Peer Sampler.">psample_init</a>(myID, NULL, 0, psample_config);

  <span class="keywordflow">return</span> myID;
}

<span class="keyword">static</span> <span class="keywordtype">void</span> loop(<span class="keyword">struct</span> nodeID *s)
{
  <span class="keywordtype">int</span> done = 0;
<span class="preprocessor">#define BUFFSIZE 1024</span>
<span class="preprocessor"></span>  <span class="keyword">static</span> uint8_t buff[BUFFSIZE];
  <span class="keywordtype">int</span> cnt = 0;

  <a name="a2"></a><a class="code" href="peersampler_8h.html#a9aa28fd02b8f72dbfbde587c6153cd47" title="Pass a received packet to the Peer Sampler.">psample_parse_data</a>(context, NULL, 0);
  <span class="keywordflow">while</span> (!done) {
    <span class="keywordtype">int</span> len;
    <span class="keywordtype">int</span> news;
    <span class="keyword">const</span> <span class="keyword">struct </span>timeval tout = {1, 0};
    <span class="keyword">struct </span>timeval t1;
    <span class="keywordtype">char</span> addr[256];

    t1 = tout;
    news = <a name="a3"></a><a class="code" href="net__helper_8h.html#aba639b19170daf84c4b84e8f59eba6a3" title="Check for newly arrived data.">wait4data</a>(s, &amp;t1, NULL);
    <span class="keywordflow">if</span> (news &gt; 0) {
      <span class="keyword">struct </span>nodeID *remote;

      len = <a name="a4"></a><a class="code" href="net__helper_8h.html#a6a7b9f1b75209bb621e03b6bb64dbcac" title="Receive data from a remote peer.">recv_from_peer</a>(s, &amp;remote, buff, BUFFSIZE);
      <a class="code" href="peersampler_8h.html#a9aa28fd02b8f72dbfbde587c6153cd47" title="Pass a received packet to the Peer Sampler.">psample_parse_data</a>(context, buff, len);
      <a name="a5"></a><a class="code" href="net__helper_8h.html#acbb39cd9f02b80f55cb9b4956f4d7e90" title="Delete a nodeID.">nodeid_free</a>(remote);
    } <span class="keywordflow">else</span> {
      <a class="code" href="peersampler_8h.html#a9aa28fd02b8f72dbfbde587c6153cd47" title="Pass a received packet to the Peer Sampler.">psample_parse_data</a>(context, NULL, 0);
      <span class="keywordflow">if</span> (cnt % 10 == 0) {
        <span class="keyword">const</span> <span class="keyword">struct </span>nodeID *<span class="keyword">const</span> *neighbourhoods;
        <span class="keywordtype">int</span> n, i;

        neighbourhoods = <a name="a6"></a><a class="code" href="peersampler_8h.html#ab84acf92c069bca078e8080721925938" title="Get a sample of the active peers.">psample_get_cache</a>(context, &amp;n);
        printf(<span class="stringliteral">&quot;I have %d neighbours:\n&quot;</span>, n);
        <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {
          <a name="a7"></a><a class="code" href="net__helper_8h.html#ad05d8fbd0811dd9cd8b9f527cc39e2fc" title="Give a string representation of a nodeID.">node_addr</a>(neighbourhoods[i], addr, 256);
          printf(<span class="stringliteral">&quot;\t%d: %s\n&quot;</span>, i, addr);
        }
        fflush(stdout);
        <span class="keywordflow">if</span> (fprefix) {
          FILE *f;
          <span class="keywordtype">char</span> fname[64];

          sprintf(fname, <span class="stringliteral">&quot;%s-%d.txt&quot;</span>, fprefix, port);
          f = fopen(fname, <span class="stringliteral">&quot;w&quot;</span>);
          <span class="keywordflow">if</span> (f) fprintf(f, <span class="stringliteral">&quot;#Cache size: %d\n&quot;</span>, n);
          <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {
            <a class="code" href="net__helper_8h.html#ad05d8fbd0811dd9cd8b9f527cc39e2fc" title="Give a string representation of a nodeID.">node_addr</a>(neighbourhoods[i], addr, 256);
            <span class="keywordflow">if</span> (f) fprintf(f, <span class="stringliteral">&quot;%d\t\t%d\t%s\n&quot;</span>, port, i, addr);
          }
          fclose(f);
        }
      }
      cnt++;
    }
  }
}

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
  <span class="keyword">struct </span>nodeID *my_sock;

  cmdline_parse(argc, argv);

  my_sock = init();
  <span class="keywordflow">if</span> (my_sock == NULL) {
    <span class="keywordflow">return</span> -1;
  }

  <span class="keywordflow">if</span> (srv_port != 0) {
    <span class="keyword">struct </span>nodeID *knownHost;

    knownHost = <a name="a8"></a><a class="code" href="net__helper_8h.html#a9dd12dbdb263ed41b6fd849e1b7e0e2d" title="Create a new nodeID.">create_node</a>(srv_ip, srv_port);
    <span class="keywordflow">if</span> (knownHost == NULL) {
      fprintf(stderr, <span class="stringliteral">&quot;Error creating knownHost socket (%s:%d)!\n&quot;</span>, srv_ip, srv_port);

      <span class="keywordflow">return</span> -1;
    }
    <a name="a9"></a><a class="code" href="peersampler_8h.html#a6c7f84277fa81df4327cdb3e7f6b16fc" title="Insert a known peer in the cache.">psample_add_peer</a>(context, knownHost, NULL, 0);
  }

  loop(my_sock);

  <span class="keywordflow">return</span> 0;
}
</pre></div> </div><!-- contents -->
</div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Fri May 3 2013 10:18:23 for GRAPES by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
